<ion-header class="ion-no-border">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/personal/dashboard"></ion-back-button>
    </ion-buttons>
    <ion-title>Treino Dinâmico</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="fullscreen-content">
  <!-- Elemento de áudio para reprodução de sons -->
  <audio #audioPlayer></audio>

  <!-- Slide principal com exercícios -->
  <swiper-container #slides
    [options]="slideOpts"
    (ionSlideDidChange)="onSlideChange()"
    (ionSlideTouchEnd)="onSlideTouch()"
    class="exercise-slides">

    <swiper-slide *ngFor="let set of workout.sets; let i = index" class="exercise-slide">
      <div class="slide-container" [ngClass]="set.exercise">
        <!-- Imagem/GIF do exercício -->
        <div class="exercise-visual">
          <img [src]="getExerciseImage(set.exercise)" alt="{{getExerciseDisplayName(set.exercise)}}">
        </div>

        <!-- Informações do exercício -->
        <div class="exercise-info">
          <h1>{{getExerciseDisplayName(set.exercise)}}</h1>
          <div class="set-details">
            <div class="detail-item">
              <ion-icon name="resize-outline"></ion-icon>
              <span>{{set.distance}}m</span>
            </div>
            <div class="detail-item">
              <ion-icon name="repeat-outline"></ion-icon>
              <span>{{set.repetitions}}x</span>
            </div>
            <div class="detail-item" *ngIf="set.restTime">
              <ion-icon name="time-outline"></ion-icon>
              <span>{{formatTime(set.restTime)}}</span>
            </div>
          </div>
          <p *ngIf="set.notes" class="exercise-notes">
            <ion-icon name="information-circle-outline"></ion-icon>
            {{set.notes}}
          </p>
        </div>

        <!-- Progresso da série atual -->
        <div class="set-progress">
          <div class="repetition-tracker">
            <div class="repetition-label">
              Repetição {{currentRepetition}}/{{set.repetitions}}
            </div>
            <div class="repetition-bubbles">
              <div *ngFor="let _ of createArray(set.repetitions); let j = index"
                  class="repetition-bubble"
                  [ngClass]="{'completed': j < currentRepetition, 'current': j === currentRepetition - 1}">
              </div>
            </div>
          </div>
        </div>

        <!-- Tempo da série atual (quando ativo) -->
        <div class="set-timer" *ngIf="isMainTimerRunning && currentSetIndex === i">
          <div class="timer-value">{{formatTime(currentTimerValue)}}</div>
        </div>
      </div>
    </swiper-slide>

    <!-- Slide final com resumo -->
    <swiper-slide class="summary-slide">
      <div class="slide-container summary">
        <ion-icon name="checkmark-circle-outline" class="summary-icon"></ion-icon>
        <h1>Treino Completo!</h1>
        <div class="summary-stats">
          <div class="stat-item">
            <div class="stat-value">{{calculateTotalDistance()}}m</div>
            <div class="stat-label">Distância Total</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">{{workout.sets.length}}</div>
            <div class="stat-label">Séries</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">{{formatTime(totalWorkoutTime)}}</div>
            <div class="stat-label">Tempo Total</div>
          </div>
        </div>
        <ion-button expand="block" (click)="finishWorkout()">
          Finalizar Treino
        </ion-button>
      </div>
    </swiper-slide>
  </swiper-container>

  <!-- Timer de descanso (overlay) -->
  <div class="rest-timer-overlay" *ngIf="isRestTimerActive">
    <div class="rest-timer-container">
      <h2>Descanso</h2>
      <div class="rest-timer-value">{{formatTime(restTimerValue)}}</div>
      <div class="rest-timer-progress">
        <div class="progress-bar" [style.width.%]="(restTimerValue / currentSet.restTime) * 100"></div>
      </div>
      <div class="rest-timer-controls">
        <ion-button fill="clear" (click)="skipRest()">
          <ion-icon name="play-skip-forward-outline"></ion-icon>
          Pular
        </ion-button>
        <ion-button fill="clear" (click)="toggleRestTimer()">
          <ion-icon [name]="isRestTimerPaused ? 'play-outline' : 'pause-outline'"></ion-icon>
          {{isRestTimerPaused ? 'Continuar' : 'Pausar'}}
        </ion-button>
      </div>
    </div>
  </div>

  <!-- Controles - sempre visíveis no fundo para o personal -->
  <div class="workout-controls" [class.with-rest-timer]="isRestTimerActive">
    <div class="control-button previous" *ngIf="currentSetIndex > 0 && !isRestTimerActive" (click)="previousSet()">
      <ion-icon name="arrow-back-outline"></ion-icon>
      <span>Anterior</span>
    </div>

    <div class="main-controls">
      <div class="main-control-button" (click)="toggleMainTimer()">
        <ion-icon [name]="isMainTimerRunning ? 'pause-outline' : 'play-outline'" class="control-icon"></ion-icon>
        <span>{{isMainTimerRunning ? 'Pausar' : 'Iniciar'}}</span>
      </div>

      <div class="main-control-button" *ngIf="isMainTimerRunning" (click)="completeRepetition()">
        <ion-icon name="checkmark-outline" class="control-icon"></ion-icon>
        <span>Completar</span>
      </div>
    </div>

    <div class="control-button next" *ngIf="currentSetIndex < workout.sets.length - 1 && !isRestTimerActive" (click)="nextSet()">
      <span>Próximo</span>
      <ion-icon name="arrow-forward-outline"></ion-icon>
    </div>
  </div>

  <!-- Indicador de progresso geral -->
  <div class="workout-progress">
    <div class="progress-label">Exercício {{currentSetIndex + 1}} de {{workout.sets.length}}</div>
    <div class="progress-bar-container">
      <div class="progress-bar" [style.width.%]="(currentSetIndex / workout.sets.length) * 100"></div>
    </div>
  </div>
</ion-content>
